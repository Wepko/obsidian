# 2.3. Проектирование базы данных

## 2.3.1. Инфологическая модель

### Основные сущности системы

#### 1. Пользователи (users)
*Основная сущность для хранения данных всех пользователей системы (клиенты, курьеры, сотрудники магазинов, администраторы)*

**Атрибуты**:
- `id` - первичный ключ
- `name` - имя пользователя
- `email` - email (уникальный)
- `email_verified_at` - метка времени подтверждения email
- `password` - хеш пароля
- `phone` - телефонный номер
- `avatar` - путь к аватару
- `type` - тип пользователя (client, courier, shop_staff, admin)
- `status` - статус (active, inactive, banned)
- `remember_token` - токен для "запомнить меня"
- `current_zone_id` - текущая зона покрытия (внешний ключ к zones)
- `created_at`, `updated_at` - метки времени

#### 2. Роли (roles)
*Система ролей для разделения прав доступа*

**Атрибуты**:
- `id` - первичный ключ
- `name` - название роли
- `guard_name` - guard для Laravel permissions
- `created_at`, `updated_at` - метки времени

#### 3. Магазины (shops)
*Сущность для хранения данных о магазинах/ресторанах*

**Атрибуты**:
- `id` - первичный ключ
- `owner_id` - владелец (внешний ключ к users)
- `name` - название магазина
- `description` - описание
- `address` - физический адрес
- `latitude` - координата широты
- `longitude` - координата долготы
- `phone` - контактный телефон
- `email` - контактный email
- `logo` - путь к логотипу
- `cover_image` - путь к обложке
- `status` - статус (active, inactive, closed)
- `is_featured` - является ли избранным
- `delivery_time` - среднее время доставки (мин)
- `delivery_fee` - стоимость доставки
- `min_order` - минимальная сумма заказа
- `tax` - налог (%)
- `module_id` - принадлежность к модулю (внешний ключ к modules)
- `zone_id` - зона покрытия (внешний ключ к zones)
- `created_at`, `updated_at` - метки времени

#### 4. Зоны покрытия (zones)
*Географические зоны доставки*

**Атрибуты**:
- `id` - первичный ключ
- `name` - название зоны
- `coordinates` - полигон зоны (GeoJSON)
- `status` - статус (active, inactive)
- `created_at`, `updated_at` - метки времени

#### 5. Курьеры (couriers)
*Дополнительные данные курьеров*

**Атрибуты**:
- `id` - первичный ключ
- `user_id` - пользователь (внешний ключ к users)
- `vehicle_type` - тип транспорта (bike, car, walk)
- `courier_type` - тип курьера (freelance, employee)
- `min_delivery_area` - минимальная зона доставки (км)
- `max_delivery_area` - максимальная зона доставки (км)
- `delivery_fee` - дополнительная плата за доставку
- `rating` - рейтинг курьера
- `status` - статус (available, unavailable, delivering)
- `current_location` - текущее местоположение (GeoJSON)
- `created_at`, `updated_at` - метки времени

#### 6. Категории товаров (categories)
*Категории для товаров магазинов*

**Атрибуты**:
- `id` - первичный ключ
- `parent_id` - родительская категория (внешний ключ к categories)
- `name` - название категории
- `image` - изображение категории
- `position` - позиция в списке
- `status` - статус (active, inactive)
- `created_at`, `updated_at` - метки времени

#### 7. Товары (products)
*Товары/блюда магазинов*

**Атрибуты**:
- `id` - первичный ключ
- `shop_id` - магазин (внешний ключ к shops)
- `category_id` - категория (внешний ключ к categories)
- `name` - название товара
- `description` - описание
- `image` - основное изображение
- `price` - цена
- `discount_price` - цена со скидкой
- `unit` - единица измерения (шт, кг, л и т.д.)
- `stock` - количество на складе
- `is_featured` - является ли избранным
- `is_active` - активен ли товар
- `created_at`, `updated_at` - метки времени

#### 8. Атрибуты товаров (product_attributes)
*Дополнительные атрибуты товаров (размер, цвет и т.д.)*

**Атрибуты**:
- `id` - первичный ключ
- `product_id` - товар (внешний ключ к products)
- `name` - название атрибута
- `price` - дополнительная цена
- `created_at`, `updated_at` - метки времени

#### 9. Дополнения товаров (product_addons)
*Дополнения к товарам (соусы, гарниры и т.д.)*

**Атрибуты**:
- `id` - первичный ключ
- `product_id` - товар (внешний ключ к products)
- `name` - название дополнения
- `price` - цена дополнения
- `created_at`, `updated_at` - метки времени

#### 10. Заказы (orders)
*Основная сущность для хранения заказов*

**Атрибуты**:
- `id` - первичный ключ
- `user_id` - клиент (внешний ключ к users)
- `shop_id` - магазин (внешний ключ к shops)
- `courier_id` - курьер (внешний ключ к couriers, nullable)
- `order_number` - уникальный номер заказа
- `order_type` - тип заказа (delivery, pickup)
- `delivery_address` - адрес доставки
- `delivery_location` - координаты доставки (GeoJSON)
- `scheduled_at` - запланированное время доставки (nullable)
- `items_count` - количество позиций
- `items_price` - стоимость товаров
- `delivery_fee` - стоимость доставки
- `tax` - налог
- `discount` - скидка
- `total` - итоговая сумма
- `payment_method` - способ оплаты (cash, card, online)
- `payment_status` - статус оплаты (pending, paid, failed)
- `order_status` - статус заказа (pending, processing, ready_for_delivery, on_delivery, delivered, cancelled)
- `shop_confirmed` - подтвержден ли магазином
- `courier_confirmed` - подтвержден ли курьером
- `notes` - заметки к заказу
- `created_at`, `updated_at` - метки времени

#### 11. Позиции заказа (order_items)
*Состав заказа - товары и их количество*

**Атрибуты**:
- `id` - первичный ключ
- `order_id` - заказ (внешний ключ к orders)
- `product_id` - товар (внешний ключ к products)
- `quantity` - количество
- `price` - цена за единицу
- `total` - общая стоимость позиции
- `created_at`, `updated_at` - метки времени

#### 12. Атрибуты позиций заказа (order_item_attributes)
*Выбранные атрибуты для позиций заказа*

**Атрибуты**:
- `id` - первичный ключ
- `order_item_id` - позиция заказа (внешний ключ к order_items)
- `attribute_id` - атрибут (внешний ключ к product_attributes)
- `created_at`, `updated_at` - метки времени

#### 13. Дополнения позиций заказа (order_item_addons)
*Выбранные дополнения для позиций заказа*

**Атрибуты**:
- `id` - первичный ключ
- `order_item_id` - позиция заказа (внешний ключ к order_items)
- `addon_id` - дополнение (внешний ключ к product_addons)
- `created_at`, `updated_at` - метки времени

#### 14. Транзакции (transactions)
*Финансовые транзакции системы*

**Атрибуты**:
- `id` - первичный ключ
- `order_id` - заказ (внешний ключ к orders, nullable)
- `user_id` - пользователь (внешний ключ к users)
- `amount` - сумма
- `type` - тип (payment, withdrawal, refund)
- `status` - статус (pending, completed, failed)
- `payment_method` - способ оплаты
- `payment_details` - детали платежа (JSON)
- `notes` - заметки
- `created_at`, `updated_at` - метки времени

#### 15. Модули (modules)
*Бизнес-модули системы*

**Атрибуты**:
- `id` - первичный ключ
- `name` - название модуля
- `type` - тип модуля
- `theme` - тема оформления
- `icon` - иконка
- `thumbnail` - миниатюра
- `status` - статус (active, inactive)
- `created_at`, `updated_at` - метки времени

#### 16. Настройки бизнеса (business_settings)
*Настройки бизнес-логики системы*

**Атрибуты**:
- `id` - первичный ключ
- `key` - ключ настройки
- `value` - значение настройки
- `created_at`, `updated_at` - метки времени

#### 17. Переводы (translations)
*Многоязычные переводы системы*

**Атрибуты**:
- `id` - первичный ключ
- `table_name` - имя таблицы
- `column_name` - имя колонки
- `foreign_key` - внешний ключ записи
- `locale` - язык (ru, en и т.д.)
- `value` - переведенное значение
- `created_at`, `updated_at` - метки времени

### Связи между сущностями

1. **users - roles**: многие-ко-многим через промежуточную таблицу `model_has_roles`
2. **users - shops**: один-ко-многим (один пользователь может владеть несколькими магазинами)
3. **shops - zones**: многие-ко-одному (магазин принадлежит одной зоне)
4. **shops - modules**: многие-ко-одному (магазин принадлежит одному модулю)
5. **users - couriers**: один-к-одному (курьер расширяет пользователя)
6. **shops - products**: один-ко-многим (магазин имеет много товаров)
7. **categories - products**: многие-ко-одному (товар принадлежит одной категории)
8. **products - product_attributes**: один-ко-многим (товар имеет много атрибутов)
9. **products - product_addons**: один-ко-многим (товар имеет много дополнений)
10. **orders - users**: многие-ко-одному (заказ принадлежит одному пользователю)
11. **orders - shops**: многие-ко-одному (заказ принадлежит одному магазину)
12. **orders - couriers**: многие-ко-одному (заказ может быть назначен одному курьеру)
13. **orders - order_items**: один-ко-многим (заказ состоит из многих позиций)
14. **order_items - products**: многие-ко-одному (позиция ссылается на один товар)
15. **order_items - order_item_attributes**: один-ко-многим (позиция может иметь много атрибутов)
16. **order_items - order_item_addons**: один-ко-многим (позиция может иметь много дополнений)

### Особенности реализации для Laravel

1. **Полиморфные отношения**:
   - Для системы ролей и разрешений используется пакет `spatie/laravel-permission`
   - Для переводов используется пакет `spatie/laravel-translatable`

2. **Мягкое удаление**:
   - Все основные сущности будут использовать SoftDeletes

3. **Шифрование**:
   - Конфиденциальные данные (платежные реквизиты) будут шифроваться

4. **События (Events)**:
   - Изменения статусов заказов будут сопровождаться событиями
   - Подтверждение заказов магазином/курьером - события

5. **Очереди (Queues)**:
   - Обработка запланированных заказов
   - Отправка уведомлений
   - Генерация отчетов

6. **API Resources**:
   - Для мобильного приложения и веб-интерфейса будут созданы API ресурсы

7. **Geo-данные**:
   - Для работы с полигонами зон и координатами будет использоваться `laravel-geo`

8. **Реализация бизнес-логики**:
   - Статусы заказов будут реализованы через State Machine
   - Проверка зоны покрытия при создании заказа

Эта инфологическая модель полностью покрывает все описанные требования системы и учитывает особенности реализации на Laravel.