### Конспект лекции: Сегментная организация виртуальной памяти

#### 1. **Введение и проблема одномерного адресного пространства**
*   **Виртуальная память** позволяет программам использовать полное адресное пространство, не завися от объема физической ОЗУ, за счет использования файла подкачки на диске.
*   **Недостаток страничной организации:** Фиксированный размер страниц приводит к внутренней фрагментации (неэффективное использование памяти) и неудобству работы с динамическими структурами данных.
*   **Проблема одномерного пространства:** В линейном (одномерном) адресном пространстве разные структуры программы (таблицы символов, исходный код, стек и т.д.), растущие независимо, могут "наезжать" друг на друга, требуя от программиста ручного управления памятью.

#### 2. **Суть сегментной организации**
*   **Сегмент** — это логически независимое адресное пространство (например, отдельный массив, стек или процедура). Каждый сегмент имеет свою длину, которая может изменяться во время выполнения программы.
*   Адрес в сегментной памяти двухмерен и задается парой: **<номер сегмента, смещение внутри сегмента>**.
*   **Преимущества сегментации:**
    *   **Упрощение работы с динамическими структурами:** Каждая структура может расти в своем сегменте, не мешая другим.
    *   **Упрощение компоновки программ:** Изменение размера одной процедуры (сегмента) не влияет на адреса других.
    *   **Разделение кода и данных:** Разные программы могут использовать общие сегменты (например, библиотеки).
    *   **Защита:** Разным сегментам можно назначить разные права доступа (только исполнение, только чтение, чтение/запись).

#### 3. **Проблемы и недостатки сегментации**
*   **Внешняя фрагментация:** Поскольку сегменты имеют переменный размер, после их загрузки и выгрузки в физической памяти образуются "дыры" (неиспользуемые фрагменты), слишком маленькие для размещения новых сегментов.
*   **Борьба с фрагментацией:**
    *   **Уплотнение (Compaction):** Перемещение всех занятых сегментов в начало памяти, чтобы собрать все свободное пространство в один большой блок. Это ресурсоемкая операция.
    *   **Алгоритмы размещения:**
        *   **First Fit:** Размещение в первом подходящем по размеру свободном блоке.
        *   **Best Fit:** Размещение в самом маленьком подходящем свободном блоке (часто приводит к появлению множества мелких бесполезных "дыр").
    *   **Слияние свободных областей:** При освобождении сегмента соседние свободные блоки объединяются в один большой.

#### 4. **Комбинированные подходы (Сегментация + Страничность)**
*   Чистая сегментация с подкачкой целых сегментов неэффективна из-за внешней фрагментации.
*   **Гибридный подход:** Каждый сегмент делится на страницы фиксированного размера. Это сочетает преимущества обоих методов:
    *   *Логическая организация* памяти — сегментная (удобно для программиста).
    *   *Физическая организация* памяти — страничная (удобно для ОС, нет внешней фрагментации).
*   Для каждого сегмента создается своя собственная таблица страниц.

#### 5. **Буфер ассоциативной трансляции (TLB)**
*   **Проблема:** Преобразование виртуального адреса в физический через таблицу страниц, хранящуюся в ОЗУ, медленно и сводит на нет преимущества кэш-памяти.
*   **Решение:** **Буфер быстрой трансляции (TLB)** — это небольшой (64-256 записей) и очень быстрый ассоциативный кэш внутри MMU, который хранит недавно использованные преобразования виртуальных адресов в физические.
*   **Принцип работы:**
    1.  CPU генерирует виртуальный адрес.
    2.  MMU сначала проверяет TLB (**TLB lookup**).
    3.  Если запись найдена (**TLB hit**), физический адрес мгновенно получен.
    4.  Если записи нет (**TLB miss**), MMU обращается к таблице страниц в ОЗУ, загружает оттуда нужное преобразование и обновляет TLB (вытесняя самую старую запись).

#### 6. **Роль операционной системы**
*   Аппаратная часть (MMU) выполняет трансляцию адресов и генерирует исключения (page fault).
*   **Супервизор (ядро ОС)** отвечает за:
    *   Обработку исключений page fault (подкачка страниц с диска).
    *   Управление таблицами страниц.
    *   Выбор страницы-жертвы для вытеснения по алгоритму (LRU, FIFO и др.).
    *   **Закрепление страниц:** Критически важные страницы (код ОС, драйверов, буферы DMA) помечаются как невыгружаемые, чтобы избежать системных сбоев.

#### 7. **Итог: Иерархия преобразования адресов в современном процессоре**
1.  CPU работает с **виртуальными адресами**.
2.  Кэш L1 часто **VIVT** (Virtually Indexed, Virtually Tagged) — работает с виртуальными адресами для скорости.
3.  **MMU** преобразует виртуальный адрес в физический с помощью **TLB**.
4.  Кэши L2/L3 и основная память работают с **физическими адресами**.

**Вывод:** Не существует единственного "лучшего" метода. Современные системы используют гибридные подходы (сегментация + страничность), сочетающие логическое удобство для программиста с эффективностью управления для ОС.