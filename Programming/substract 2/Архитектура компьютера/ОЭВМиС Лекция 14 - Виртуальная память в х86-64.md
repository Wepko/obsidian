### Подробный пересказ лекции: Реализация виртуальной памяти в архитектуре x86-64

#### 1. **Введение в архитектуру x86-64**
*   **x86-64** (также известная как AMD64, Intel 64, EM64T) — это 64-битное расширение архитектуры x86, разработанное компанией AMD в 2000 году.
*   Ключевая особенность — почти полная обратная совместимость с 32-битным кодом x86.
*   Процессор поддерживает два основных режима работы:
    *   **Длинный режим (Long Mode):** Нативный 64-битный режим. Требует 64-битную ОС. Позволяет выполнять 64-битные программы и, для совместимости, 32-битные приложения (но они не могут использовать 64-битные системные библиотеки).
    *   **Унаследованный режим (Legacy Mode):** Режим полной совместимости с 32-битным x86. В этом режиме процессор ведёт себя как старый x86 (например, Pentium III), а 64-битные функции недоступны. Включает подрежимы:
        *   *Реальный режим* (как в MS-DOS, используется при загрузке через BIOS).
        *   *Защищённый режим* (для 32-битных многозадачных ОС, например, Windows XP).
        *   *Режим виртуального 8086* (для эмуляции DOS-машин, не поддерживается в 64-битных Windows).

#### 2. **Трансляция адресов: Исторический контекст и сегментация**
*   Современная трансляция адресов в x86 — это **гибридная сегментно-страничная модель**, унаследованная из-за требований обратной совместимости.
*   **Историческая причина сегментации:** 16-битные процессоры (например, 8086) имели 16-битные регистры и могли адресовать только 64 КБ памяти. Чтобы обойти это ограничение, инженеры ввели **сегментные регистры** (CS, DS, SS, ES, FS, GS).
    *   **Физический адрес** вычислялся как: `(Сегментный_регистр * 16) + Смещение`. Это позволяло адресовать до ~1 МБ памяти.
*   В **32-битном защищённом режиме** сегментация стала сложнее и реализовала настоящую виртуальную память:
    *   Расположение сегментов описывается структурами в памяти — **таблицами дескрипторов** (GDT — глобальная таблица дескрипторов, общая для всех программ, и LDT — локальная таблица дескрипторов, своя для каждой программы).
    *   **Селектор** в сегментном регистре теперь является индексом в таблице дескрипторов, а не частью адреса.
    *   **Дескриптор сегмента** содержит его базовый адрес, размер и атрибуты (права доступа).
    *   **Линейный адрес** получается путем сложения базового адреса из дескриптора и смещения из команды.
*   **Защита с помощью колец привилегий:** Существует 4 уровня привилегий (кольца 0-3). Большинство ОС используют только кольцо 0 (ядро) и кольцо 3 (пользовательские приложения). Код не может accessing данные или код более привилегированного кольца. Это обеспечивается проверкой полей CPL (текущий уровень привилегий), RPL (запрошенный уровень в селекторе) и DPL (уровень привилегий дескриптора).

#### 3. **Длинный режим (64-битный) и упрощение сегментации**
*   В **64-битном длинном режиме** сегментация практически **отключена** для упрощения и повышения производительности.
    *   Базовые адреса для сегментных регистров CS, DS, ES, SS **принудительно установлены в 0**. Это создает "плоскую модель памяти" (flat memory model), где логические адреса сразу являются линейными.
    *   Регистры FS и GS могут иметь ненулевой 64-битный базовый адрес (устанавливается через MSR), что позволяет ОС использовать их для служебных целей (например, хранения указателей на структуры данных ядра или текущего потока).
*   **GDT** все еще существует, но содержит минимум записей (обычно 5: пустая, код ядра, данные ядра, код пользователя, данные пользователя). **LDT** больше не используется.

#### 4. **Страничная организация памяти в x86-64**
*   Основной механизм виртуальной памяти в 64-битном режиме — **4-уровневая страничная трансляция**.
*   **Канонические адреса:** Хотя виртуальные адреса 64-битные, реально используются только младшие 48 бит. Старшие 16 бит (48-63) должны быть копией 47-го бита (это "каноническая форма"). Это делит адресное пространство на две половины:
    *   **Пользовательское пространство:** Нижняя половина (адреса с 0...).
    *   **Пространство ядра:** Верхняя половина (адреса с старшими битами, равными 1).
*   **Уровни таблиц страниц:**
    1.  **PML4 (Page Map Level 4):** Указывается регистром **CR3**. Содержит 512 записей по 8 байт.
    2.  **PDP (Page Directory Pointer):** Каждая запись в PML4 указывает на таблицу PDP.
    3.  **PD (Page Directory):** Каждая запись в PDP указывает на таблицу PD.
    4.  **PT (Page Table):** Каждая запись в PD указывает на таблицу PT, которая уже содержит физические адреса страниц.
*   **Размер страниц:** По умолчанию 4 КБ. Также поддерживаются **huge pages** размером 2 МБ (тогда запись в PD указывает напрямую на фрейм) и 1 ГБ (тогда запись в PDP указывает на фрейм).
*   **Формат записи в таблице страниц (PTE):** 64 бита. Содержит:
    *   **Физический адрес фрейма** (биты 12-51, так как адреса выровнены по границе страницы).
    *   **Флаги управления:** Present (страница в памяти), Read/Write, User/Supervisor, Accessed, Dirty, Global, Disable Cache, Execute Disable (NX bit) и другие.

#### 5. **Ускорение трансляции: TLB**
*   **Буфер ассоциативной трансляции (TLB)** — это небольшой и очень быстрый кэш внутри процессора, хранящий недавно использованные преобразования виртуальных адресов в физические.
*   **Важное отличие от других кэшей:** TLB **не прозрачен**. При изменении таблиц страниц (например, при подкачке) ядро ОС должно вручную сбрасывать соответствующие записи в TLB с помощью инструкции `INVLPG` или перезагрузки регистра CR3.

#### 6. **Проблемы совместимости и будущее**
*   Изначально AMD хотела полностью убрать сегментацию в x86-64, но это вызвало проблемы у разработчиков программ виртуализации (например, VMware), которые использовали сегментацию для изоляции монитора виртуальной машины от гостевой ОС.
*   В результате **ограниченная поддержка сегментации была возвращена** в последующие ревизии архитектуры.
*   С распространением аппаратной виртуализации (Intel VT-x, AMD-V) необходимость в сегментации для этих целей постепенно отпадает.

#### 7. **Заключение**
*   Виртуальная память в x86-64 — это результат долгой эволюции, где современная эффективная **4-уровневая страничная организация** сочетается с **унаследованным механизмом сегментации**, практически отключенным, но оставленным для совместимости и некоторых специфических задач.
*   Ключевые компоненты системы: таблицы страниц (PML4, PDP, PD, PT), TLB для ускорения и механизм защиты через кольца привилегий.
*   Понимание этой сложной, но тщательно оптимизированной системы необходимо для работы с низкоуровневым программированием, разработкой ОС и систем виртуализации.